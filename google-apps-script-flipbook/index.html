<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="mobile-web-app-capable" content="yes">
  <title>PDF Flipbook</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <!-- jQuery UI (Turn.js iÃ§in gerekli) -->
  <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>

  <!-- Turn.js (GitHub raw link) -->
  <script src="https://raw.githack.com/blasten/turn.js/master/turn.min.js"></script>

  <!-- PDF.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

  <!-- Stil dosyasÄ± -->
  <style>
    <?!= include('stil'); ?>
  </style>
</head>
<body>
  <!-- YÃ¼kleme gÃ¶stergesi -->
  <div id="loading">
    <div class="spinner"></div>
    <p>PDF yÃ¼kleniyor...</p>
  </div>

  <!-- Flipbook konteyneri -->
  <div id="flipbook-container" style="display: none;">
    <!-- Flipbook ve yan butonlar -->
    <div id="flipbook-wrapper" class="d-flex align-items-center justify-content-center">
      <button id="prev-btn" class="side-button">â—€</button>
      <div id="flipbook"></div>
      <button id="next-btn" class="side-button">â–¶</button>
    </div>
  </div>

  <!-- MÃ¼zik kontrolleri (ayrÄ±) -->
  <div id="music-controls" class="d-flex justify-content-center gap-2" style="display: none !important; position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 1000;">
    <button id="play-music-btn" class="btn btn-light btn-sm">â–¶ Ã‡al</button>
    <button id="pause-music-btn" class="btn btn-light btn-sm" style="display: none;">â¸ Duraklat</button>
  </div>

  <!-- MÃ¼zik elementi (gizli) -->
  <audio id="background-music" loop>
    <source src="" type="audio/mpeg">
  </audio>

  <script>
    // Sayfa yÃ¼klendiÄŸinde PDF'i al
    $(document).ready(function() {
      console.log('Sayfa yÃ¼klendi, PDF alÄ±nÄ±yor...');
      // Sunucudan PDF verilerini al
      google.script.run
        .withSuccessHandler(onPdfLoaded)
        .withFailureHandler(onError)
        .getPdfAsBase64();
    });

    /**
     * PDF baÅŸarÄ±yla yÃ¼klendiÄŸinde Ã§alÄ±ÅŸÄ±r
     */
    function onPdfLoaded(base64Data) {
      console.log('PDF verisi alÄ±ndÄ±, iÅŸleniyor...');

      // PDF.js worker dosyasÄ±nÄ±n yolunu ayarla
      pdfjsLib.GlobalWorkerOptions.workerSrc =
        'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

      // Base64 verisini PDF formatÄ±na dÃ¶nÃ¼ÅŸtÃ¼r
      var pdfData = atob(base64Data);
      var uint8Array = new Uint8Array(pdfData.length);
      for (var i = 0; i < pdfData.length; i++) {
        uint8Array[i] = pdfData.charCodeAt(i);
      }

      // PDF'i yÃ¼kle
      var loadingTask = pdfjsLib.getDocument({data: uint8Array});

      loadingTask.promise.then(function(pdf) {
        console.log('PDF yÃ¼klendi, toplam sayfa:', pdf.numPages);
        var totalPages = pdf.numPages;
        var renderedPages = [];

        // TÃ¼m sayfalarÄ± sÄ±rayla render et
        var renderPromise = Promise.resolve();

        for (var pageNum = 1; pageNum <= totalPages; pageNum++) {
          (function(num) {
            renderPromise = renderPromise.then(function() {
              return renderPage(pdf, num).then(function(pageData) {
                renderedPages.push(pageData);
                console.log('Sayfa render edildi:', num, '/', totalPages);
              });
            });
          })(pageNum);
        }

        renderPromise.then(function() {
          console.log('TÃ¼m sayfalar render edildi:', renderedPages.length);

          // Sayfa numarasÄ±na gÃ¶re sÄ±rala
          renderedPages.sort(function(a, b) {
            return a.pageNum - b.pageNum;
          });

          // SayfalarÄ± sÄ±rayla flipbook'a ekle
          renderedPages.forEach(function(pageData, index) {
            var pageDiv = $('<div></div>').addClass('page');

            // Div'in boyutunu hesaplanan sayfa boyutuna ayarla
            pageDiv.css({
              'width': pageData.pageWidth + 'px',
              'height': pageData.pageHeight + 'px',
              'display': 'flex',
              'justify-content': index % 2 === 0 ? 'flex-start' : 'flex-end', // Sol sayfalar sola, saÄŸ sayfalar saÄŸa
              'align-items': 'center',
              'overflow': 'visible'
            });

            // Canvas'Ä±n yÃ¼ksekliÄŸi %100 olsun, geniÅŸliÄŸi otomatik
            $(pageData.canvas).css({
              'height': '100%',
              'width': 'auto',
              'object-fit': 'contain',
              'display': 'block'
            });

            pageDiv.append(pageData.canvas);
            $('#flipbook').append(pageDiv);
            console.log('Sayfa eklendi:', index + 1);
          });

          console.log('Flipbook\'ta toplam div sayÄ±sÄ±:', $('#flipbook > div').length);

          // YÃ¼kleme gÃ¶stergesini gizle
          $('#loading').hide();

          // Flipbook konteyneri gÃ¶ster
          $('#flipbook-container').show();

          // Turn.js'nin yÃ¼klenip yÃ¼klenmediÄŸini kontrol et
          if (typeof $.fn.turn !== 'function') {
            console.error('Turn.js yÃ¼klenemedi! KÃ¼tÃ¼phane bulunamadÄ±.');
            $('#loading').html('<p style="color: red;">Turn.js kÃ¼tÃ¼phanesi yÃ¼klenemedi. LÃ¼tfen internet baÄŸlantÄ±nÄ±zÄ± kontrol edin.</p>').show();
            $('#flipbook-container').hide();
            return;
          }

          // Turn.js'yi baÅŸlat
          try {
            console.log('Turn.js baÅŸlatÄ±lÄ±yor...');
            console.log('Turn.js versiyonu:', $.fn.turn ? 'YÃ¼klendi' : 'YÃ¼klenmedi');

            // Ekran boyutuna gÃ¶re flipbook boyutunu ve gÃ¶rÃ¼nÃ¼mÃ¼nÃ¼ ayarla
            var screenWidth = $(window).width();
            var flipbookWidth = 1400;
            var flipbookHeight = 900;
            var displayMode = 'double';

            // Responsive boyutlar
            if (screenWidth <= 360) {
              flipbookWidth = screenWidth;
              flipbookHeight = Math.min(screenWidth * 1.3, window.innerHeight * 0.65);
              displayMode = 'single';
            } else if (screenWidth <= 500) {
              flipbookWidth = screenWidth;
              flipbookHeight = Math.min(screenWidth * 1.2, window.innerHeight * 0.7);
              displayMode = 'single';
            } else if (screenWidth <= 650) {
              flipbookWidth = Math.min(500, screenWidth - 80);
              flipbookHeight = 400;
              displayMode = 'double';
            } else if (screenWidth <= 750) {
              flipbookWidth = 600;
              flipbookHeight = 450;
            } else if (screenWidth <= 950) {
              flipbookWidth = 700;
              flipbookHeight = 500;
            } else if (screenWidth <= 1050) {
              flipbookWidth = 900;
              flipbookHeight = 600;
            } else if (screenWidth <= 1250) {
              flipbookWidth = 1000;
              flipbookHeight = 650;
            } else if (screenWidth <= 1500) {
              flipbookWidth = 1200;
              flipbookHeight = 750;
            }

            $('#flipbook').turn({
              width: flipbookWidth,
              height: flipbookHeight,
              autoCenter: true,
              elevation: 50,
              gradients: true,
              acceleration: true,
              display: displayMode,
              duration: 1000,
              when: {
                turning: function(event, page, view) {
                  console.log('Sayfa Ã§evriliyor:', page);
                },
                turned: function(event, page, view) {
                  console.log('Sayfa Ã§evrildi:', page);
                },
                start: function(event, pageObject, corner) {
                  console.log('Ã‡evirme baÅŸladÄ±');
                }
              }
            });

            console.log('Turn.js baÅŸlatÄ±ldÄ±!');
            console.log('Mevcut sayfa sayÄ±sÄ±:', $('#flipbook').turn('pages'));

            // Kontrol butonlarÄ±nÄ± baÄŸla
            $('#prev-btn').click(function() {
              $('#flipbook').turn('previous');
            });

            $('#next-btn').click(function() {
              $('#flipbook').turn('next');
            });

            // Klavye kontrolÃ¼
            $(document).keydown(function(e) {
              if (e.keyCode == 37) { // Sol ok
                $('#flipbook').turn('previous');
              } else if (e.keyCode == 39) { // SaÄŸ ok
                $('#flipbook').turn('next');
              }
            });

            // Flipbook'a SADECE tÄ±klama ile ileri/geri gitme (swipe KAPALI)
            $('#flipbook').on('click', function(e) {
              var flipbookWidth = $(this).width();
              var clickX = e.pageX - $(this).offset().left;

              // Sol yarÄ±ya tÄ±klandÄ±ysa geri git
              if (clickX < flipbookWidth / 2) {
                $('#flipbook').turn('previous');
                console.log('Sol tarafa tÄ±klandÄ± - Ã¶nceki sayfa');
              }
              // SaÄŸ yarÄ±ya tÄ±klandÄ±ysa ileri git
              else {
                $('#flipbook').turn('next');
                console.log('SaÄŸ tarafa tÄ±klandÄ± - sonraki sayfa');
              }
            });

            // Hover efekti iÃ§in cursor deÄŸiÅŸtir
            $('#flipbook').css('cursor', 'pointer');

            // Touch eventlerini devre dÄ±ÅŸÄ± bÄ±rak (swipe yok)
            $('#flipbook').on('touchstart touchmove touchend', function(e) {
              e.preventDefault();
              e.stopPropagation();
            });

            // MÃ¼zik kontrollerini baÅŸlat
            initMusicControls();

            // Window resize event - Otomatik yeniden boyutlandÄ±rma
            var resizeTimer;
            $(window).on('resize', function() {
              clearTimeout(resizeTimer);
              resizeTimer = setTimeout(function() {
                resizeFlipbook();
              }, 250);
            });

          } catch(e) {
            console.error('Turn.js baÅŸlatma hatasÄ±:', e);
          }
        });
      }).catch(function(error) {
        onError(error);
      });
    }

    /**
     * Flipbook'u pencere boyutuna gÃ¶re yeniden boyutlandÄ±r
     */
    function resizeFlipbook() {
      var screenWidth = $(window).width();
      var flipbookWidth = 1400;
      var flipbookHeight = 900;
      var displayMode = 'double';

      // Responsive boyutlar
      if (screenWidth <= 360) {
        flipbookWidth = screenWidth;
        flipbookHeight = Math.min(screenWidth * 1.3, window.innerHeight * 0.65);
        displayMode = 'single';
      } else if (screenWidth <= 500) {
        flipbookWidth = screenWidth;
        flipbookHeight = Math.min(screenWidth * 1.2, window.innerHeight * 0.7);
        displayMode = 'single';
      } else if (screenWidth <= 650) {
        flipbookWidth = Math.min(500, screenWidth - 80);
        flipbookHeight = 400;
        displayMode = 'double';
      } else if (screenWidth <= 750) {
        flipbookWidth = 600;
        flipbookHeight = 450;
      } else if (screenWidth <= 950) {
        flipbookWidth = 700;
        flipbookHeight = 500;
      } else if (screenWidth <= 1050) {
        flipbookWidth = 900;
        flipbookHeight = 600;
      } else if (screenWidth <= 1250) {
        flipbookWidth = 1000;
        flipbookHeight = 650;
      } else if (screenWidth <= 1500) {
        flipbookWidth = 1200;
        flipbookHeight = 750;
      }

      console.log('Resize: ' + screenWidth + 'px â†’ Flipbook: ' + flipbookWidth + 'x' + flipbookHeight);

      // Turn.js boyutunu gÃ¼ncelle
      $('#flipbook').turn('size', flipbookWidth, flipbookHeight);

      // Display mode'u gÃ¼ncelle
      if ($('#flipbook').turn('display') !== displayMode) {
        $('#flipbook').turn('display', displayMode);
      }
    }

    /**
     * Bir PDF sayfasÄ±nÄ± render eder
     */
    function renderPage(pdf, pageNum) {
      return pdf.getPage(pageNum).then(function(page) {
        // Canvas oluÅŸtur
        var canvas = document.createElement('canvas');
        var context = canvas.getContext('2d');

        // Ekran boyutuna gÃ¶re sayfa boyutunu belirle
        var screenWidth = $(window).width();
        var pageWidth = 700;
        var pageHeight = 900;

        // Responsive boyutlar
        if (screenWidth <= 360) {
          pageWidth = screenWidth;
          pageHeight = Math.min(screenWidth * 1.3, window.innerHeight * 0.65);
        } else if (screenWidth <= 500) {
          pageWidth = screenWidth;
          pageHeight = Math.min(screenWidth * 1.2, window.innerHeight * 0.7);
        } else if (screenWidth <= 650) {
          pageWidth = Math.min(250, (screenWidth - 80) / 2);
          pageHeight = 400;
        } else if (screenWidth <= 750) {
          pageWidth = 300;
          pageHeight = 450;
        } else if (screenWidth <= 950) {
          pageWidth = 350;
          pageHeight = 500;
        } else if (screenWidth <= 1050) {
          pageWidth = 450;
          pageHeight = 600;
        } else if (screenWidth <= 1250) {
          pageWidth = 500;
          pageHeight = 650;
        } else if (screenWidth <= 1500) {
          pageWidth = 600;
          pageHeight = 750;
        }

        // Sayfa boyutlarÄ±nÄ± ayarla
        var viewport = page.getViewport({scale: 1.0});

        // PDF'i tam olarak sayfa boyutuna sÄ±ÄŸdÄ±r (aspect ratio korunarak)
        var scaleX = pageWidth / viewport.width;
        var scaleY = pageHeight / viewport.height;
        var scale = Math.min(scaleX, scaleY); // KÃ¼Ã§Ã¼ÄŸÃ¼nÃ¼ kullan (kÄ±rpmadan sÄ±ÄŸdÄ±r)

        viewport = page.getViewport({scale: scale});

        // Canvas boyutunu viewport'a gÃ¶re ayarla
        canvas.width = viewport.width;
        canvas.height = viewport.height;

        // SayfayÄ± render et (transform olmadan)
        var renderContext = {
          canvasContext: context,
          viewport: viewport
        };

        return page.render(renderContext).promise.then(function() {
          return {
            pageNum: pageNum,
            canvas: canvas,
            pageWidth: pageWidth,
            pageHeight: pageHeight
          };
        });
      });
    }

    /**
     * Hata oluÅŸtuÄŸunda Ã§alÄ±ÅŸÄ±r
     */
    function onError(error) {
      console.error('Hata oluÅŸtu:', error);
      $('#loading').html('<p style="color: red;">Hata: ' + error.message + '</p>');
    }

    /**
     * MÃ¼zik kontrollerini baÅŸlatÄ±r
     */
    function initMusicControls() {
      var audio = document.getElementById('background-music');
      var playBtn = $('#play-music-btn');
      var pauseBtn = $('#pause-music-btn');
      var volumeSlider = $('#volume-slider');
      var volumeLabel = $('#volume-label');

      // MÃ¼zik dosyasÄ±nÄ± base64 olarak sunucudan al
      google.script.run
        .withSuccessHandler(function(musicData) {
          if (musicData && musicData !== '') {
            audio.src = musicData;
            console.log('MÃ¼zik yÃ¼klendi (base64)');
            $('#music-controls').show(); // MÃ¼zik yÃ¼klendiyse kontrolÃ¼ gÃ¶ster
          } else {
            console.log('MÃ¼zik dosyasÄ± ayarlanmamÄ±ÅŸ.');
            playBtn.prop('disabled', true);
            playBtn.text('ğŸµ MÃ¼zik Yok');
          }
        })
        .withFailureHandler(function(error) {
          console.error('MÃ¼zik alÄ±namadÄ±:', error);
        })
        .getMusicAsBase64();

      // MÃ¼zik Ã§al butonu
      playBtn.click(function() {
        if (audio.src && audio.src !== '' && audio.src !== window.location.href) {
          audio.play().then(function() {
            playBtn.hide();
            pauseBtn.show();
            console.log('MÃ¼zik Ã§alÄ±yor...');
          }).catch(function(error) {
            console.error('MÃ¼zik Ã§alÄ±namadÄ±:', error);
            alert('MÃ¼zik Ã§alÄ±namadÄ±. LÃ¼tfen dosyanÄ±n paylaÅŸÄ±m izinlerini kontrol edin.');
          });
        } else {
          alert('LÃ¼tfen Ã¶nce Kod.gs dosyasÄ±nda mÃ¼zik dosyasÄ± ID\'sini ayarlayÄ±n ve dosyayÄ± herkese aÃ§Ä±k olarak paylaÅŸÄ±n!');
        }
      });

      // MÃ¼zik duraklat butonu
      pauseBtn.click(function() {
        audio.pause();
        pauseBtn.hide();
        playBtn.show();
        console.log('MÃ¼zik duraklatÄ±ldÄ±.');
      });

      // Ses seviyesi kontrolÃ¼
      volumeSlider.on('input', function() {
        var volume = $(this).val();
        audio.volume = volume / 100;
        volumeLabel.text(volume + '%');
      });

      // BaÅŸlangÄ±Ã§ ses seviyesi
      audio.volume = 0.5;

      // MÃ¼zik bitince yeniden baÅŸlat (loop zaten var ama yine de)
      audio.addEventListener('ended', function() {
        audio.currentTime = 0;
        audio.play();
      });
    }
  </script>
</body>
</html>
