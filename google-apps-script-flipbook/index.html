<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="mobile-web-app-capable" content="yes">
  <title>PDF Flipbook</title>

  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

  <!-- jQuery UI (Turn.js iÃ§in gerekli) -->
  <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>

  <!-- Turn.js (GitHub raw link) -->
  <script src="https://raw.githack.com/blasten/turn.js/master/turn.min.js"></script>

  <!-- PDF.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

  <!-- Stil dosyasÄ± -->
  <style>
    <?!= include('stil'); ?>
  </style>
</head>
<body>
  <!-- YÃ¼kleme gÃ¶stergesi -->
  <div id="loading">
    <div class="spinner"></div>
    <p>PDF yÃ¼kleniyor...</p>
  </div>

  <!-- Flipbook konteyneri -->
  <div id="flipbook-container" style="display: none;">
    <!-- Flipbook ve yan butonlar -->
    <div id="flipbook-wrapper">
      <button id="prev-btn" class="side-button">â—€</button>
      <div id="flipbook"></div>
      <button id="next-btn" class="side-button">â–¶</button>
    </div>

    <!-- Alt kontroller -->
    <div id="controls">
      <span id="page-info"></span>
    </div>

    <!-- MÃ¼zik kontrolleri (gizli - isteÄŸe baÄŸlÄ±) -->
    <div id="music-controls" style="display: none;">
      <button id="play-music-btn">ğŸµ MÃ¼zik Ã‡al</button>
      <button id="pause-music-btn" style="display: none;">â¸ Duraklat</button>
      <div id="volume-control">
        <span>ğŸ”Š Ses:</span>
        <input type="range" id="volume-slider" min="0" max="100" value="50">
        <span id="volume-label">50%</span>
      </div>
    </div>
  </div>

  <!-- MÃ¼zik elementi (gizli) -->
  <audio id="background-music" loop>
    <source src="" type="audio/mpeg">
  </audio>

  <script>
    // Sayfa yÃ¼klendiÄŸinde PDF'i al
    $(document).ready(function() {
      console.log('Sayfa yÃ¼klendi, PDF alÄ±nÄ±yor...');
      // Sunucudan PDF verilerini al
      google.script.run
        .withSuccessHandler(onPdfLoaded)
        .withFailureHandler(onError)
        .getPdfAsBase64();
    });

    /**
     * PDF baÅŸarÄ±yla yÃ¼klendiÄŸinde Ã§alÄ±ÅŸÄ±r
     */
    function onPdfLoaded(base64Data) {
      console.log('PDF verisi alÄ±ndÄ±, iÅŸleniyor...');

      // PDF.js worker dosyasÄ±nÄ±n yolunu ayarla
      pdfjsLib.GlobalWorkerOptions.workerSrc =
        'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

      // Base64 verisini PDF formatÄ±na dÃ¶nÃ¼ÅŸtÃ¼r
      var pdfData = atob(base64Data);
      var uint8Array = new Uint8Array(pdfData.length);
      for (var i = 0; i < pdfData.length; i++) {
        uint8Array[i] = pdfData.charCodeAt(i);
      }

      // PDF'i yÃ¼kle
      var loadingTask = pdfjsLib.getDocument({data: uint8Array});

      loadingTask.promise.then(function(pdf) {
        console.log('PDF yÃ¼klendi, toplam sayfa:', pdf.numPages);
        var totalPages = pdf.numPages;
        var renderedPages = [];

        // TÃ¼m sayfalarÄ± sÄ±rayla render et
        var renderPromise = Promise.resolve();

        for (var pageNum = 1; pageNum <= totalPages; pageNum++) {
          (function(num) {
            renderPromise = renderPromise.then(function() {
              return renderPage(pdf, num).then(function(pageData) {
                renderedPages.push(pageData);
                console.log('Sayfa render edildi:', num, '/', totalPages);
              });
            });
          })(pageNum);
        }

        renderPromise.then(function() {
          console.log('TÃ¼m sayfalar render edildi:', renderedPages.length);

          // Sayfa numarasÄ±na gÃ¶re sÄ±rala
          renderedPages.sort(function(a, b) {
            return a.pageNum - b.pageNum;
          });

          // SayfalarÄ± sÄ±rayla flipbook'a ekle
          renderedPages.forEach(function(pageData, index) {
            var pageDiv = $('<div></div>').addClass('page');
            pageDiv.append(pageData.canvas);
            $('#flipbook').append(pageDiv);
            console.log('Sayfa eklendi:', index + 1);
          });

          console.log('Flipbook\'ta toplam div sayÄ±sÄ±:', $('#flipbook > div').length);

          // YÃ¼kleme gÃ¶stergesini gizle
          $('#loading').hide();

          // Flipbook konteyneri gÃ¶ster
          $('#flipbook-container').show();

          // Turn.js'nin yÃ¼klenip yÃ¼klenmediÄŸini kontrol et
          if (typeof $.fn.turn !== 'function') {
            console.error('Turn.js yÃ¼klenemedi! KÃ¼tÃ¼phane bulunamadÄ±.');
            $('#loading').html('<p style="color: red;">Turn.js kÃ¼tÃ¼phanesi yÃ¼klenemedi. LÃ¼tfen internet baÄŸlantÄ±nÄ±zÄ± kontrol edin.</p>').show();
            $('#flipbook-container').hide();
            return;
          }

          // Turn.js'yi baÅŸlat
          try {
            console.log('Turn.js baÅŸlatÄ±lÄ±yor...');
            console.log('Turn.js versiyonu:', $.fn.turn ? 'YÃ¼klendi' : 'YÃ¼klenmedi');

            // Ekran boyutuna gÃ¶re flipbook boyutunu ve gÃ¶rÃ¼nÃ¼mÃ¼nÃ¼ ayarla
            var screenWidth = $(window).width();
            var flipbookWidth = 1400;
            var flipbookHeight = 900;
            var displayMode = 'double';

            // Responsive boyutlar
            if (screenWidth <= 360) {
              flipbookWidth = screenWidth;
              flipbookHeight = Math.min(screenWidth * 1.3, window.innerHeight * 0.65);
              displayMode = 'single';
            } else if (screenWidth <= 500) {
              flipbookWidth = screenWidth;
              flipbookHeight = Math.min(screenWidth * 1.2, window.innerHeight * 0.7);
              displayMode = 'single';
            } else if (screenWidth <= 650) {
              flipbookWidth = Math.min(500, screenWidth - 80);
              flipbookHeight = 400;
              displayMode = 'double';
            } else if (screenWidth <= 750) {
              flipbookWidth = 600;
              flipbookHeight = 450;
            } else if (screenWidth <= 950) {
              flipbookWidth = 700;
              flipbookHeight = 500;
            } else if (screenWidth <= 1050) {
              flipbookWidth = 900;
              flipbookHeight = 600;
            } else if (screenWidth <= 1250) {
              flipbookWidth = 1000;
              flipbookHeight = 650;
            } else if (screenWidth <= 1500) {
              flipbookWidth = 1200;
              flipbookHeight = 750;
            }

            $('#flipbook').turn({
              width: flipbookWidth,
              height: flipbookHeight,
              autoCenter: true,
              elevation: 50,
              gradients: true,
              acceleration: true,
              display: displayMode,
              duration: 1000,
              when: {
                turning: function(event, page, view) {
                  console.log('Sayfa Ã§evriliyor:', page);
                  updatePageInfo();
                },
                turned: function(event, page, view) {
                  console.log('Sayfa Ã§evrildi:', page);
                  updatePageInfo();
                },
                start: function(event, pageObject, corner) {
                  console.log('Ã‡evirme baÅŸladÄ±');
                }
              }
            });

            console.log('Turn.js baÅŸlatÄ±ldÄ±!');
            console.log('Mevcut sayfa sayÄ±sÄ±:', $('#flipbook').turn('pages'));

            // Sayfa bilgisini gÃ¼ncelle
            updatePageInfo();

            // Kontrol butonlarÄ±nÄ± baÄŸla
            $('#prev-btn').click(function() {
              $('#flipbook').turn('previous');
            });

            $('#next-btn').click(function() {
              $('#flipbook').turn('next');
            });

            // Klavye kontrolÃ¼
            $(document).keydown(function(e) {
              if (e.keyCode == 37) { // Sol ok
                $('#flipbook').turn('previous');
              } else if (e.keyCode == 39) { // SaÄŸ ok
                $('#flipbook').turn('next');
              }
            });

            // Flipbook'a tÄ±klama/dokunma ile ileri/geri gitme
            $('#flipbook').on('click touchend', function(e) {
              e.preventDefault();

              var flipbookWidth = $(this).width();
              var clickX;

              // Touch veya mouse event'i al
              if (e.type === 'touchend') {
                var touch = e.originalEvent.changedTouches[0];
                clickX = touch.pageX - $(this).offset().left;
              } else {
                clickX = e.pageX - $(this).offset().left;
              }

              // Sol yarÄ±ya tÄ±klandÄ±ysa/dokunulursa geri git
              if (clickX < flipbookWidth / 2) {
                $('#flipbook').turn('previous');
                console.log('Sol tarafa dokunuldu - Ã¶nceki sayfa');
              }
              // SaÄŸ yarÄ±ya tÄ±klandÄ±ysa/dokunulursa ileri git
              else {
                $('#flipbook').turn('next');
                console.log('SaÄŸ tarafa dokunuldu - sonraki sayfa');
              }
            });

            // Hover efekti iÃ§in cursor deÄŸiÅŸtir
            $('#flipbook').css('cursor', 'pointer');

            // Swipe gesture desteÄŸi (mobil iÃ§in)
            var touchStartX = 0;
            var touchEndX = 0;

            $('#flipbook').on('touchstart', function(e) {
              touchStartX = e.originalEvent.changedTouches[0].screenX;
            });

            $('#flipbook').on('touchmove', function(e) {
              touchEndX = e.originalEvent.changedTouches[0].screenX;
            });

            $('#flipbook').on('touchend', function(e) {
              // Swipe uzunluÄŸu kontrolÃ¼ (minimum 50px)
              var swipeLength = Math.abs(touchEndX - touchStartX);

              if (swipeLength > 50) {
                // SaÄŸa kaydÄ±rma (swipe right) - Ã¶nceki sayfa
                if (touchEndX > touchStartX) {
                  $('#flipbook').turn('previous');
                  console.log('SaÄŸa kaydÄ±rÄ±ldÄ± - Ã¶nceki sayfa');
                }
                // Sola kaydÄ±rma (swipe left) - sonraki sayfa
                else {
                  $('#flipbook').turn('next');
                  console.log('Sola kaydÄ±rÄ±ldÄ± - sonraki sayfa');
                }
              }
            });

            // MÃ¼zik kontrollerini baÅŸlat
            initMusicControls();

          } catch(e) {
            console.error('Turn.js baÅŸlatma hatasÄ±:', e);
          }
        });
      }).catch(function(error) {
        onError(error);
      });
    }

    /**
     * Sayfa bilgisini gÃ¼nceller
     */
    function updatePageInfo() {
      var currentPage = $('#flipbook').turn('page');
      var totalPages = $('#flipbook').turn('pages');
      $('#page-info').text('Sayfa ' + currentPage + ' / ' + totalPages);
    }

    /**
     * Bir PDF sayfasÄ±nÄ± render eder
     */
    function renderPage(pdf, pageNum) {
      return pdf.getPage(pageNum).then(function(page) {
        // Canvas oluÅŸtur
        var canvas = document.createElement('canvas');
        var context = canvas.getContext('2d');

        // Sayfa boyutlarÄ±nÄ± ayarla (sayfaya gÃ¶re dinamik scale)
        var viewport = page.getViewport({scale: 1.0});

        // SayfayÄ± 700x900'e sÄ±ÄŸacak ÅŸekilde Ã¶lÃ§ekle
        var scale = Math.min(700 / viewport.width, 900 / viewport.height);
        viewport = page.getViewport({scale: scale});

        canvas.width = viewport.width;
        canvas.height = viewport.height;

        // SayfayÄ± render et
        var renderContext = {
          canvasContext: context,
          viewport: viewport
        };

        return page.render(renderContext).promise.then(function() {
          return {
            pageNum: pageNum,
            canvas: canvas
          };
        });
      });
    }

    /**
     * Hata oluÅŸtuÄŸunda Ã§alÄ±ÅŸÄ±r
     */
    function onError(error) {
      console.error('Hata oluÅŸtu:', error);
      $('#loading').html('<p style="color: red;">Hata: ' + error.message + '</p>');
    }

    /**
     * MÃ¼zik kontrollerini baÅŸlatÄ±r
     */
    function initMusicControls() {
      var audio = document.getElementById('background-music');
      var playBtn = $('#play-music-btn');
      var pauseBtn = $('#pause-music-btn');
      var volumeSlider = $('#volume-slider');
      var volumeLabel = $('#volume-label');

      // MÃ¼zik dosyasÄ±nÄ± base64 olarak sunucudan al
      google.script.run
        .withSuccessHandler(function(musicData) {
          if (musicData && musicData !== '') {
            audio.src = musicData;
            console.log('MÃ¼zik yÃ¼klendi (base64)');
            $('#music-controls').show(); // MÃ¼zik yÃ¼klendiyse kontrolÃ¼ gÃ¶ster
          } else {
            console.log('MÃ¼zik dosyasÄ± ayarlanmamÄ±ÅŸ.');
            playBtn.prop('disabled', true);
            playBtn.text('ğŸµ MÃ¼zik Yok');
          }
        })
        .withFailureHandler(function(error) {
          console.error('MÃ¼zik alÄ±namadÄ±:', error);
        })
        .getMusicAsBase64();

      // MÃ¼zik Ã§al butonu
      playBtn.click(function() {
        if (audio.src && audio.src !== '' && audio.src !== window.location.href) {
          audio.play().then(function() {
            playBtn.hide();
            pauseBtn.show();
            console.log('MÃ¼zik Ã§alÄ±yor...');
          }).catch(function(error) {
            console.error('MÃ¼zik Ã§alÄ±namadÄ±:', error);
            alert('MÃ¼zik Ã§alÄ±namadÄ±. LÃ¼tfen dosyanÄ±n paylaÅŸÄ±m izinlerini kontrol edin.');
          });
        } else {
          alert('LÃ¼tfen Ã¶nce Kod.gs dosyasÄ±nda mÃ¼zik dosyasÄ± ID\'sini ayarlayÄ±n ve dosyayÄ± herkese aÃ§Ä±k olarak paylaÅŸÄ±n!');
        }
      });

      // MÃ¼zik duraklat butonu
      pauseBtn.click(function() {
        audio.pause();
        pauseBtn.hide();
        playBtn.show();
        console.log('MÃ¼zik duraklatÄ±ldÄ±.');
      });

      // Ses seviyesi kontrolÃ¼
      volumeSlider.on('input', function() {
        var volume = $(this).val();
        audio.volume = volume / 100;
        volumeLabel.text(volume + '%');
      });

      // BaÅŸlangÄ±Ã§ ses seviyesi
      audio.volume = 0.5;

      // MÃ¼zik bitince yeniden baÅŸlat (loop zaten var ama yine de)
      audio.addEventListener('ended', function() {
        audio.currentTime = 0;
        audio.play();
      });
    }
  </script>
</body>
</html>
